---
clone:
  disable: true
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-wasm-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    image: meltwater/drone-cache:latest
    name: restore-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      region: eu-west-1
      restore: true
  - commands:
      - cp wasm/checksums.json wasm/original-checksums.json
      - make build-wasm-scripts
    depends_on:
      - restore-cache
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: build-wasm
    pull: never
  - commands:
      - >-
        aws s3 sync wasm s3://heliax-drone-wasm-v2 --exclude "*" --include
        "*.wasm" --exclude "*/*"
      - cp wasm/checksums.json wasm/${DRONE_COMMIT}.json
      - aws s3 cp wasm/${DRONE_COMMIT}.json s3://heliax-drone-wasm-v2
    depends_on:
      - build-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: update-wasm
    pull: never
  - commands:
      - make test-wasm
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: test-wasm
    pull: never
  - commands:
      - cmp -- wasm/checksums.json wasm/original-checksums.json
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: check-wasm
    pull: never
  - commands:
      - rm -f  ./wasm/wasm_source/target/.rustc_info.json
      - rm -rf ./wasm/wasm_source/target/debug
      - find ./wasm/wasm_source/target/release -maxdepth 1 -type f -delete
      - >-
        find ./wasm/wasm_source/target/wasm32-unknown-unknown -maxdepth 1 -type
        f -delete
    depends_on:
      - test-wasm
      - check-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: clean-cache
    pull: never
    when:
      status:
        - success
        - failure
  - depends_on:
      - clean-cache
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      BACKEND_OPERATION_TIMEOUT: 8m
    image: meltwater/drone-cache:latest
    name: rebuild-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      override: false
      rebuild: true
      region: eu-west-1
    when:
      status:
        - success
        - failure
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/wasm
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-build-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make build
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build
    pull: never
  - commands:
      - sccache --start-server
      - make build-test
    depends_on:
      - build
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-test
    pull: never
  - commands:
      - >-
        aws s3api head-object --bucket heliax-drone-wasm-v2 --key
        ${DRONE_COMMIT}.json
      - if [ $? -ne 0  ]; then exit 1; fi
      - aws s3 cp s3://heliax-drone-wasm-v2/${DRONE_COMMIT}.json wasm
      - cp wasm/${DRONE_COMMIT}.json wasm/checksums.json
      - >-
        jq -r -c '.[]' wasm/checksums.json | parallel aws s3 cp
        s3://heliax-drone-wasm-v2/{} wasm
    depends_on:
      - build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: download-wasm
    pull: never
  - commands:
      - sccache --start-server
      - make test-unit
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-unit
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-unit
    pull: never
  - commands:
      - sccache --start-server
      - make test-e2e
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-e2e
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-e2e
    pull: never
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-build-abci-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make build-abci-plus-plus
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-abci
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build
    pull: never
  - commands:
      - sccache --start-server
      - make build-test-abci-plus-plus
    depends_on:
      - build
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-test-abci
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-test
    pull: never
  - commands:
      - >-
        aws s3api head-object --bucket heliax-drone-wasm-v2 --key
        ${DRONE_COMMIT}.json
      - if [ $? -ne 0  ]; then exit 1; fi
      - aws s3 cp s3://heliax-drone-wasm-v2/${DRONE_COMMIT}.json wasm
      - cp wasm/${DRONE_COMMIT}.json wasm/checksums.json
      - >-
        jq -r -c '.[]' wasm/checksums.json | parallel aws s3 cp
        s3://heliax-drone-wasm-v2/{} wasm
    depends_on:
      - build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: download-wasm
    pull: never
  - commands:
      - sccache --start-server
      - make test-unit-abci-plus-plus
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-unit-abci
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-unit
    pull: never
  - commands:
      - sccache --start-server
      - make test-e2e-abci-plus-plus
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-e2e-abci
      TENDERMINT: /usr/local/bin/tendermint++
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-e2e
    pull: never
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/abci
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-checks-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make clippy
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-clippy
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: clippy
    pull: never
  - commands:
      - sccache --start-server
      - make fmt-check
    depends_on:
      - check-scripts-integrity
      - clippy
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-format
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: format
    pull: never
trigger:
  branch:
    - develop
    - master
  event:
    - push
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-checks-abci-pr
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make clippy-abci-plus-plus
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-clippy-abci
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: clippy
    pull: never
trigger:
  branch:
    - develop
    - master
  event:
    - push
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/abci
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-misc-pr
node:
  project: anoma
steps:
  - commands:
      - git clone $DRONE_GIT_HTTP_URL .
      - git fetch --all
      - git checkout $DRONE_TARGET_BRANCH
      - git merge $DRONE_COMMIT
      - CONFLICTS=$(git ls-files -u | wc -l)
      - if [ "$CONFLICTS" -gt 0 ]; then exit 1; fi;exit 0
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - sh scripts/ci/build-and-publish-docs.sh
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-docs
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-and-publish-docs
    pull: never
trigger:
  event:
    - pull_request
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-cron
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - >-
        curl -sSL
        https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py
        | python3 -
      - . $HOME/.poetry/env
      - cargo generate-lockfile
      - cd scripts/ci && poetry install && poetry run python3 audit.py
    depends_on:
      - check-scripts-integrity
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: audit
    pull: never
  - commands:
      - sccache --start-server
      - >-
        curl -sSL
        https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py
        | python3 -
      - . $HOME/.poetry/env
      - cd scripts/ci && poetry install && poetry run python3 udeps.py
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-udeps
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: udeps
    pull: never
trigger:
  cron:
    - audit
  event:
    - cron
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-miri-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make test-miri || true
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-miri
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-miri
    pull: never
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-docs-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - sh scripts/ci/build-and-publish-docs.sh
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-docs
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-and-publish-docs
    pull: never
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-build-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - make build
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build
    pull: never
  - commands:
      - sccache --start-server
      - make build-test
    depends_on:
      - build
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-test
    pull: never
  - commands:
      - >-
        aws s3api head-object --bucket heliax-drone-wasm-v2 --key
        ${DRONE_COMMIT}.json
      - if [ $? -ne 0  ]; then exit 1; fi
      - aws s3 cp s3://heliax-drone-wasm-v2/${DRONE_COMMIT}.json wasm
      - cp wasm/${DRONE_COMMIT}.json wasm/checksums.json
      - >-
        jq -r -c '.[]' wasm/checksums.json | parallel aws s3 cp
        s3://heliax-drone-wasm-v2/{} wasm
    depends_on:
      - build-test
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: download-wasm
    pull: never
  - commands:
      - sccache --start-server
      - make test-unit
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-unit
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-unit
    pull: never
  - commands:
      - sccache --start-server
      - make test-e2e
    depends_on:
      - download-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-test-e2e
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: test-e2e
    pull: never
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/anoma
---
clone:
  disable: true
environment:
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-wasm-master
node:
  project: anoma
steps:
  - commands:
      - >-
        git clone $DRONE_GIT_HTTP_URL --quiet --branch
        ${DRONE_SOURCE_BRANCH:-master} --single-branch .
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    image: meltwater/drone-cache:latest
    name: restore-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      region: eu-west-1
      restore: true
  - commands:
      - cp wasm/checksums.json wasm/original-checksums.json
      - make build-wasm-scripts
    depends_on:
      - restore-cache
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: build-wasm
    pull: never
  - commands:
      - >-
        aws s3 sync wasm s3://heliax-drone-wasm-v2 --exclude "*" --include
        "*.wasm" --exclude "*/*"
      - cp wasm/checksums.json wasm/${DRONE_COMMIT}.json
      - aws s3 cp wasm/${DRONE_COMMIT}.json s3://heliax-drone-wasm-v2
    depends_on:
      - build-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: update-wasm
    pull: never
  - commands:
      - make test-wasm
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: test-wasm
    pull: never
  - commands:
      - cmp -- wasm/checksums.json wasm/original-checksums.json
    depends_on:
      - update-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: check-wasm
    pull: never
  - commands:
      - >-
        aws s3 sync wasm s3://heliax-anoma-wasm-v1 --acl public-read --exclude
        "*" --include "*.wasm" --exclude "*/*"
      - cp wasm/checksums.json wasm/${DRONE_COMMIT}.json
      - >-
        aws s3 cp wasm/${DRONE_COMMIT}.json s3://heliax-anoma-wasm-v1 --acl
        public-read
    depends_on:
      - test-wasm
      - check-wasm
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: upload-wasm
    pull: never
  - commands:
      - rm -f  ./wasm/wasm_source/target/.rustc_info.json
      - rm -rf ./wasm/wasm_source/target/debug
      - find ./wasm/wasm_source/target/release -maxdepth 1 -type f -delete
      - >-
        find ./wasm/wasm_source/target/wasm32-unknown-unknown -maxdepth 1 -type
        f -delete
    depends_on:
      - test-wasm
      - check-wasm
      - upload-wasm
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/wasm:latest
    name: clean-cache
    pull: never
    when:
      status:
        - success
        - failure
  - depends_on:
      - clean-cache
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      BACKEND_OPERATION_TIMEOUT: 8m
    image: meltwater/drone-cache:latest
    name: rebuild-cache
    pull: never
    settings:
      archive_format: gzip
      backend: s3
      bucket: heliax-drone-cache-v2
      cache_key: 1-54-0/wasm/{{ checksum "wasm/wasm_source/Cargo.lock" }}
      mount:
        - wasm/wasm_source/target
      override: false
      rebuild: true
      region: eu-west-1
    when:
      status:
        - success
        - failure
trigger:
  branch:
    - master
  event:
    - push
type: docker
workspace:
  path: /usr/local/rust/wasm
---
clone:
  disable: true
environment:
  CARGO_INCREMENTAL: '0'
  GIT_LFS_SKIP_SMUDGE: '1'
kind: pipeline
name: anoma-ci-release
node:
  project: anoma
steps:
  - commands:
      - git clone $DRONE_GIT_HTTP_URL .
      - git fetch --all
      - git checkout $DRONE_TARGET_BRANCH
      - git merge $DRONE_COMMIT
      - CONFLICTS=$(git ls-files -u | wc -l)
      - if [ "$CONFLICTS" -gt 0 ]; then exit 1; fi;exit 0
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: clone
    pull: never
  - commands:
      - >-
        echo "4665b6ec95b864d57f129d898488dd5c4cc5be29736b23782859a2a3cb446111 
        Makefile" | sha256sum -c -
      - >-
        echo "96f503edaeb65d5b75855c75ead35c6c3e394ee82ec6fd4aa15d0e7d9f1051d6 
        wasm/wasm_source/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/vp_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/tx_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_template/Makefile" | sha256sum -c -
      - >-
        echo "52d59575c0767b4738ea9b4c07844c761dce6f54a59b3429e75fb5f4410cdc7e 
        wasm/mm_filter_template/Makefile" | sha256sum -c -
      - >-
        echo "f01f320575fbbbd3d0ba0f2dd7e9b0132e8448e4e07ce99d425d9ad03d811428 
        docs/Makefile" | sha256sum -c -
      - >-
        echo "7dd312b1ce11d7e51583d4281833f64599bdc991a8cb5780c75f2f1188a24257 
        scripts/ci/pre-run.sh" | sha256sum -c -
      - >-
        echo "bbf66c628d4916b5c931997968afdf2cc85b4362d731d9e47152627e59cfd0f2 
        scripts/ci/release.sh" | sha256sum -c -
      - >-
        echo "404295040e689276676d7f33ade9abbd09f36a7120a3389887de1d47f8895dfe 
        scripts/ci/build-and-publish-docs.sh" | sha256sum -c -
      - >-
        echo "0d74ca6426ebaed9df0b87061ced2be6d71667ef70fa7681b63b61ea2c68e665 
        scripts/ci/audit.py" | sha256sum -c -
      - >-
        echo "2308b636047c8e9fe684fcb3d09ba6777636ce314cbae9d489be3a84596ab0e3 
        scripts/ci/udeps.py" | sha256sum -c -
      - >-
        echo "36e8de3f31a5f8a9e4b0f45b105cb7116def8a7204c662f129678fda2dfa0f04 
        wasm/checksums.py" | sha256sum -c -
      - sh scripts/ci/pre-run.sh
    depends_on:
      - clone
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: check-scripts-integrity
    pull: never
  - commands:
      - sccache --start-server
      - sh scripts/ci/build-and-publish-docs.sh
    depends_on:
      - check-scripts-integrity
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      GITHUB_TOKEN:
        from_secret: github_token
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-docs
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-and-publish-docs
    pull: never
  - commands:
      - sccache --start-server
      - make package
    depends_on:
      - build-and-publish-docs
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
      SCCACHE_BUCKET: heliax-drone-cache-v2
      SCCACHE_S3_KEY_PREFIX: sccache-build-release
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/anoma:latest
    name: build-package
    pull: never
  - commands:
      - sh scripts/ci/release.sh
    depends_on:
      - build-package
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    image: 965844283396.dkr.ecr.eu-west-1.amazonaws.com/git:latest
    name: create-release
    pull: never
trigger:
  event:
    - tag
type: docker
workspace:
  path: /usr/local/rust/anoma
---
kind: signature
hmac: db507944d1e46933ca985de1de98faba3253b94cad5d73a463bf89fcbc960b11

...
